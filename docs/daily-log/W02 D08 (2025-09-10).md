# W02 D08 (2025-09-10)

## ✅ 오늘 한 일

### BE
- **Order 모듈 IdempotencyKey 충돌 해결**
  - 왜? → 결제 요청 시 동일 주문이 중복 생성되어 `Duplicate entry for idempotency_key` 에러 발생.  
  - 그래서 → `createOrder` 에서 `findByIdempotencyKey` 선 조회 후 반환하도록 수정. DB 유니크 제약 조건 확인.  
  - 결과 → 중복 요청 방지 및 안정적인 주문 생성 동작 확인.

- **SAGA Worker & Outbox 동작 검증**
  - 왜? → 이벤트 기반 결제 플로우(Order → Payment → Reservation → Catalog)를 끝까지 추적할 필요가 있었음.  
  - 그래서 → Outbox 테이블에 PAYMENT_SUCCESS / PAYMENT_FAILED 이벤트 저장 후, Worker가 Kafka로 발행 → 각 모듈 연동 로그 확인.  
  - 결과 → 전체 이벤트 흐름이 정상 동작하며 좌석 상태가 최종적으로 Catalog SSE에 반영됨을 확인.

---

### FE
- **CheckoutPage UI/로직 리팩토링**
  - 왜? → 주문 생성 후 결제 상태 확인이 중복 요청되거나 UX가 불편했음.  
  - 그래서 → 
    - `useEffect` 내 idempotencyKey를 `useState(() => crypto.randomUUID())` 로 생성해 안정화.  
    - 주문 상태 polling 구현 후 CONFIRMED / CANCELLED 시 `clearInterval` 로 polling 중단.  
    - toast 메시지 개선 (`loading → success/error`).  
    - Card UI 컴포넌트(`Card`, `CardContent`, `CardHeader`, `CardTitle`) 적용.  
  - 결과 → 결제 완료 시 "✅ 결제 완료" 표시, 실패 시 "❌ 결제 실패" 표시. 중복 요청 없음. UX 개선된 Checkout 화면 구현.

- **UI 컴포넌트 정리**
  - 왜? → shadcn/ui 기반 `button.tsx`, `card.tsx` 등이 필요했으나 프로젝트에 없음.  
  - 그래서 → `/src/components/ui/button.tsx`, `/src/components/ui/card.tsx` 작성. `cn` 유틸 연결.  
  - 결과 → FE 공용 컴포넌트 구조 정리 완료. 재사용성 확보.

- **MyTicketsPage 뼈대 생성**
  - 왜? → 예매 내역 페이지 필요.  
  - 그래서 → 기본 라우트 및 뼈대 UI 컴포넌트 작성.  
  - 결과 → `/my-tickets` 페이지 진입 가능. 향후 확장 기반 마련.

---

### Infra/테스트
- **네트워크 탭 분석**
  - 왜? → CheckoutPage에서 polling 중복 요청 문제 원인 확인 필요.  
  - 그래서 → DevTools Network 확인 → React StrictMode, useEffect 동작 구조 확인.  
  - 결과 → polling 정상화, 불필요한 2회 요청 제거. 최종 상태 이후 추가 요청 멈춤.

- **End-to-End 플로우 추적 (Jaeger + 로그)**
  - 왜? → 단일 요청이 여러 모듈을 거쳐 전체 시스템에서 좌석 상태까지 반영되는 과정을 확인해야 함.  
  - 그래서 → Jaeger Trace + 모듈 로그로 플로우 추적:  
    1. **Order 모듈**: FE에서 주문 생성 요청 → Outbox에 `PAYMENT_REQUEST` 이벤트 기록  
    2. **Payment 모듈**: 이벤트 수신 → 결제 성공/실패 여부 결정 후 `PAYMENT_SUCCESS/FAILED` 발행  
    3. **Order 모듈**: Payment 이벤트 수신 → 주문 상태 업데이트(CONFIRMED / CANCELLED)  
    4. **Reservation 모듈**: 주문 상태 따라 좌석 확정(SOLD) 또는 해제(AVAILABLE)  
    5. **Catalog 모듈**: Reservation 이벤트 반영 후 좌석 상태 변경  
    6. **SSE → Frontend**: Catalog SSE로 좌석 변경 이벤트 push → FE 좌석 UI 실시간 업데이트  
  - 결과 → 하나의 결제 요청이 모든 모듈을 거쳐 최종적으로 FE UI까지 반영되는 end-to-end 검증 완료.

---

## 📚 배운 점
- **IdempotencyKey 패턴**
  - 중복 결제/주문 방지 핵심 기법.  
  - 분산 환경(MSA)에서 안정성 확보를 위해 반드시 필요.
- **Outbox + Saga 패턴**
  - 이벤트 발행과 상태 전이를 원자적으로 보장.  
  - 모듈 간 eventual consistency를 유지하는 핵심 아키텍처.
- **Polling vs SSE**
  - 현재는 polling으로 처리했지만, Catalog 모듈처럼 SSE로 확장 가능.  
  - 실시간 이벤트 스트리밍이 더 자연스러운 방향임을 학습.
- **React StrictMode 동작**
  - 개발 모드에서 useEffect 2회 실행됨 → idempotent 코드 작성 필요.

---

## 💡 느낀 점 / 회고
- BE/FE 양쪽에서 idempotencyKey가 중요한 개념임을 체감했다.  
- Outbox/Saga 패턴을 직접 보면서, 단일 트랜잭션 기반 설계와 다른 **이벤트 기반 분산 설계의 장점**을 경험했다.  
- FE에서는 polling 중단 로직 하나가 UX에 큰 차이를 만든다는 걸 확인.  
- 지금은 polling으로 충분하지만, 나중에는 SSE 기반 실시간 업데이트로 전환해야 더 효율적일 것 같음.  
- 공용 UI 컴포넌트(button, card)와 utils를 직접 정리하면서 FE 구조가 점점 실서비스 구조에 가까워짐을 느꼈다.

---

## 📊 검증 결과 (DoD)
- ✅ 주문 생성 시 중복 Order row 없음 (IdempotencyKey 정상 동작).  
- ✅ Order → Payment → Order → Reservation → Catalog → SSE → FE end-to-end 플로우 정상 검증.  
- ✅ Outbox에 PAYMENT_SUCCESS / FAILED 이벤트 기록 및 Kafka 발행 성공.  
- ✅ 좌석 상태가 CONFIRMED 시 SOLD, CANCELLED 시 AVAILABLE 로 실시간 반영됨.  
- ✅ FE CheckoutPage에서 결제 성공/실패 상태가 올바르게 표시됨.  
- ✅ CONFIRMED 상태 이후 polling 멈춤.  
- ✅ MyTicketsPage 라우팅 가능.  

---

## 📸 결과물 캡처
![Checkout 성공](./images/checkout_success.png)  
![네트워크 요청 정상화](./images/network_polling_stop.png)  
![예매 내역 뼈대](./images/mytickets_page.png)  
![End-to-End Trace](./images/jaeger_trace.png)  
