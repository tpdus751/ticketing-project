# W01 D05 (2025-09-01)

## ✅ 오늘 한 일

### BE

* **ReservationService에 Micrometer Observation 추가 (db/redis 자식 스팬 기록)**

  * 왜? → 단일 HTTP span만 찍히던 Jaeger 트레이스를 DB 조회, Redis setnx, delete 같은 단계별로 쪼개서 추적하기 위함.
  * 그래서 → `Observation.createNotStarted(...).observe(...)`로 DB/Redis 호출을 감싸고, `@Observed`를 서비스 메서드에 부여.
  * 결과 → Jaeger에서 confirm 요청을 클릭하면 내부에 `redis.hold.exists`, `redis.hold.delete`, `db.seat.mark-sold` 같은 자식 span이 표시됨.

* **MDC 기반 traceId 로깅 연계**

  * 왜? → Jaeger trace와 애플리케이션 로그를 연결해야 장애 상황 시 추적 가능.
  * 그래서 → `TraceIdFilter`에 `MDC.put("traceId", traceId)` 세팅하고, Logback 패턴에 `%X{traceId}` 출력 추가.
  * 결과 → 콘솔 로그에 `trace=...` 형태로 traceId가 출력, Jaeger UI의 trace와 로그를 매칭 가능.

### FE

* 별도 신규 개발 없음.

  * 대신 Grafana Dashboard에서 데이터 시각화 확인을 통해, **FE에서 호출하는 예약 API가 지표/트레이스로 반영되는 것**을 검증.

### Infra/테스트

* **Grafana Dashboard에 KPI 패널 추가**

  * 왜? → 예약 성공률, 충돌 수, 평균/피크 레이턴시를 한눈에 보기 위함.
  * 그래서 → Prometheus 쿼리(`histogram_quantile`, `sum(rate(...))`)를 사용하여 p95 latency, HTTP 5xx rate, SLO success rate 패널 구성.
  * 결과 → SLO 게이지(Confirm success rate), Hold/Confirm 성공/실패 카운터, p95 레이턴시 그래프, HTTP 5xx 에러율 패널까지 시각화 완료.

* **k6 부하 테스트 재실행**

  * 왜? → 트레이스/메트릭이 실제로 수집되는지 검증하기 위해.
  * 그래서 → 30 VU, 40초 시나리오로 smoke test 실행.
  * 결과 → Grafana에 Hold/Confirm 지표가 집계되고, Jaeger에 자식 span이 표시됨.

---

## 📚 배운 점

* **Micrometer Observation**
  → Spring Boot 3.5부터 OpenTelemetry 연계가 기본화. `Observation` API로 코드 레벨에서 세밀하게 span 생성 가능.
  → 단일 HTTP 요청만 보는 것보다, DB/Redis 단계를 쪼개야 병목 구간이 보인다.

* **로그 ↔ 트레이스 연계**
  → 분산 추적의 traceId를 로그에도 출력하면, 장애 분석 시 "이 로그가 Jaeger의 어떤 트레이스인지" 바로 매칭 가능.
  → 추상적 모니터링 지표(Grafana)와 구체적 실행 흐름(Jaeger) 사이의 다리 역할.

* **SLO 기반 대시보드 설계**
  → 단순 카운트/성공률이 아닌 “목표치(≥99%)”를 패널 임계값으로 설정해 운영 기준을 명확히 세울 수 있다.

---

## 💡 느낀 점 / 회고

* 단순히 성능 테스트 결과를 보는 것보다, **메트릭/트레이스/로그가 유기적으로 연결**되니 전체 시스템을 "하나의 생명체"처럼 바라볼 수 있었다.
* BE 개발자 입장에서, Redis/DB 쿼리가 병목이 되는 순간을 바로 Jaeger에서 눈으로 확인할 수 있다는 게 큰 장점.
* 앞으로 FE/BE 협업 시 "FE 요청 → BE 처리 단계별 지연"을 같이 리뷰할 수 있어, 팀 단위로 품질을 관리할 수 있겠다고 느낌.

---

## 📊 검증 결과 (DoD)

* **Grafana**

  * Confirm success rate = 100% (SLO 충족)
  * Hold success = 102건, Hold conflict = 21건 정상 기록
  * HTTP 5xx 에러율 = 0
  * p95 레이턴시 패널에서 confirm ≈ 35ms, hold ≈ 50ms로 관측됨

* **Jaeger**

  * Confirm API 트레이스에 자식 span(`redis.hold.exists`, `redis.hold.delete`, `db.seat.mark-sold`)이 기록됨
  * Trace 타임라인에서 각 단계별 소요 시간 확인 가능

* **로그**

  * 콘솔 로그에 `trace=<UUID>` 출력 확인
  * Jaeger traceId와 동일한 값으로 매칭 성공

---

## 📸 결과물 캡처

![아키텍처](./images/W01 D05 Architect.png)
![Grafana 대시보드 1](./images/W01 D05 grafana.png)
![Grafana 대시보드 2](./images/W01 D05 grafana2.png)
![Jaeger 트레이스](./images/W01 D05 Jaeger trace.png)
