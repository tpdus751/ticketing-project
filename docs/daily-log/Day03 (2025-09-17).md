# W03 D03 (2025-09-17)

## ✅ 오늘 한 일

### BE
- **GitHub Actions CI/CD 최종 세팅**
  - 왜? → 로컬에서 수동으로 EC2 접속 후 빌드/배포 과정을 반복하는 것은 번거롭고, 자동화가 필요했음.  
  - 그래서 → `deploy.yml` 워크플로우에 4개 모듈(Catalog, Reservation, Order, Payment) 각각의 Jib 빌드 & GHCR 푸시, 그리고 EC2 원격 접속 후 `docker compose pull` + `up -d` 실행까지 파이프라인 완성.  
  - 결과 → 로컬에서 `git push origin main` 하면 자동으로 이미지 빌드 → GHCR 푸시 → EC2에서 최신 이미지 pull → 컨테이너 재기동까지 **풀 오토매틱 배포** 성공.  

- **포트 충돌 및 잘못된 이미지 기동 문제 해결**
  - 왜? → 초기 배포 시 모든 모듈이 8081 포트로 실행되고, catalog 컨테이너 로그에서도 reservation 로그가 찍히는 등 잘못된 이미지가 기동되는 문제가 발생했음.  
  - 그래서 → `docker-compose.prod.yml`에 각 모듈의 `image`와 `service` 매핑, `ports` 확인 및 `docker compose -f docker-compose.prod.yml pull`로 강제 최신 이미지 동기화.  
  - 결과 → 모듈별 이미지 정상 구분, 로그에도 각 모듈별 prefix(CATALOG/RESERVATION/ORDER/PAYMENT) 잘 출력됨.  

- **로그 포맷 개선**
  - 왜? → 기존 로그는 시간만 `HH:mm:ss.SSS` 형식으로 나오고 traceId가 `NA`로 찍히는 경우가 있었음.  
  - 그래서 → `logback-spring.xml`에 `%d{yyyy-MM-dd HH:mm:ss.SSS}` 패턴 반영, TraceIdFilter + MDC 연동으로 traceId가 로그 라인마다 표시되도록 수정.  
  - 결과 → 각 모듈 로그가 `2025-09-17 07:21:03.534 INFO [thread] [CATALOG] trace=...` 형식으로 보기 좋게 출력됨.  

### Infra/DevOps
- **GHCR Push 문제 해결**
  - 왜? → `other: blob upload unknown to registry` 에러로 이미지 push가 실패.  
  - 그래서 → PAT 권한(scope: `write:packages`) 재확인, Actions에서 `:reservation:jib` 같은 방식으로 모듈 지정 후 빌드.  
  - 결과 → GHCR private 레지스트리에도 정상 push 가능, EC2에서 pull 성공.  

- **GitHub Actions → EC2 배포 스크립트 수정**
  - 왜? → 초기에 `docker compose pull`만 실행되어 DB/Redis 등 인프라 서비스만 pull되고, BE 모듈 이미지는 갱신되지 않는 문제가 있었음.  
  - 그래서 → `cd ticketing/infra && sudo docker compose -f docker-compose.prod.yml pull` 로 명시.  
  - 결과 → Catalog/Reservation/Order/Payment 4개 모듈 이미지도 자동 갱신됨.  

- **워크플로우 실패 알림 채널 점검**
  - 왜? → 현재는 Actions 실패 시 GitHub UI에서 직접 확인해야 함.  
  - 그래서 → GitHub 기본 Notifications 설정을 확인하여 Actions 실패 시 이메일 알림이 오도록 활성화.  
  - 결과 → CI/CD 실패 즉시 메일로 확인 가능, Day03의 Fail-safe 역할 수행.  

---

## 📚 배운 점
- Jib 빌드시 **모듈 네임스페이스(:catalog:jib)** 지정 필요성.  
- `docker compose -f` 옵션으로 정확한 compose 파일을 지정해야 이미지 pull이 제대로 반영됨.  
- GitHub Actions에서 `if: failure()` 조건을 활용하면 Slack/Email 등 알림을 붙일 수 있고, 현재는 GitHub Notification만으로도 충분히 Fail-safe 가능.  

---

## 🚀 내일 할 일 (Day04 예정)
- k6 부하테스트 스크립트 작성 (1000 VU, oversell=0, p95 < 300ms 목표).  
- Grafana + Prometheus 메트릭 시각화 연동 검증.  
- EC2에서 장시간 실행 시 안정성 테스트 진행.  

---

## 🎥 결과물 캡처/로그
- ![CI/CD Actions 성공 로그 스크린샷](./images/Day03 CICD ScreenShot.png)  
- `docker ps` 결과: 각 모듈(Catalog/Reservation/Order/Payment) 개별 컨테이너 정상 기동.  
- Logback 출력 예시: 날짜+traceId 포함된 로그 확인.  

---

👉 오늘 Day03까지로 **로컬 → GitHub → Actions → GHCR → EC2 배포 자동화 파이프라인 완성** 🎉  
내일부터는 **성능/안정성 튜닝 단계 (Day04~)** 로 들어감.  
