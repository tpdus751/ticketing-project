# W3 D12 (2025-09-16)

## ✅ 오늘 한 일

### Infra/배포
- **EC2 단일 노드 스테이징 환경 구축**
  - 왜? → 로컬 개발 환경에서만 동작하던 모듈들을 실제 배포 환경(EC2 t3.medium)에서 검증하기 위함.  
  - 그래서 → Ubuntu 22.04 EC2 인스턴스 생성 후 `docker`, `docker compose` 설치 및 `/srv/ticketing` 디렉토리 구성.  
  - 결과 → Catalog/Reservation/Order/Payment + Infra(mysql, redis, kafka, jaeger, nginx) 컨테이너 정상 기동.

- **모듈별 컨테이너 이미지 빌드 & GHCR 연동**
  - 왜? → EC2에서 최신 모듈을 가져와 실행하려면 GitHub Packages 기반 이미지 관리가 필요함.  
  - 그래서 → 각 모듈(`catalog`, `reservation`, `order`, `payment`)을 `./gradlew :module:jib`으로 빌드 후 GHCR 푸시.  
  - 결과 → `docker compose pull && up -d` 로 EC2에서 최신 모듈 기동 성공.

- **Nginx 리버스 프록시 설정**
  - 왜? → 외부 클라이언트가 `/ticketing/...` 경로로 각 모듈 API 접근 가능하도록 통합 게이트웨이 필요.  
  - 그래서 → `nginx.conf` 수정, REST API 라우팅과 SSE 버퍼링 해제 옵션 적용.  
  - 결과 → 
    - `/ticketing/catalog/api/events` 조회 OK  
    - `/ticketing/catalog/api/events/{id}/seats/stream` SSE 지연 없이 동작 OK  

---

### BE
- **Reservation ↔ Catalog 통신 문제 해결**
  - 왜? → Reservation 모듈이 Catalog에 `localhost`로 요청을 보내 연결 실패 발생.  
  - 그래서 → `http://catalog:8080/...` 로 내부 네트워크 주소 사용하도록 수정 후 재빌드.  
  - 결과 → Reservation → Catalog 내부 API 호출 성공, 좌석 변경 이벤트 정상 반영.

- **Order ↔ Payment 통신 문제 해결**
  - 왜? → Order 모듈이 Payment를 `localhost:8083` 으로 호출해 실패.  
  - 그래서 → `http://payment:8083/...` 로 수정 후 재빌드.  
  - 결과 → 결제 요청 → 승인 플로우 정상 처리.

---

### FE
- **EC2 배포 환경 연결 확인**
  - 왜? → 프론트에서 EC2 API 호출이 제대로 동작해야 전체 시나리오 검증 가능.  
  - 그래서 → `.env`의 API_BASE 들을 EC2 퍼블릭 IP 기반으로 수정 (`VITE_CATALOG_API=http://<EC2>/ticketing/catalog/` 등).  
  - 결과 → 프론트에서 이벤트 조회, 좌석 조회, 예약/주문/결제까지 E2E 플로우 성공.

- **SSE 스트림 지연 문제 해결**
  - 왜? → 좌석 변경 이벤트가 다른 브라우저에 반영되기까지 9초 이상 지연 발생.  
  - 그래서 → Nginx SSE 라우트에서 `proxy_buffering off`, `X-Accel-Buffering no`, `proxy_read_timeout` 등 옵션 적용.  
  - 결과 → 브라우저간 좌석 반영 지연 1~2초 수준으로 개선.

---

## 📚 배운 점
- `proxy_pass` 경로 매핑 시 `/` 처리 여부에 따라 URI 전달 방식이 달라진다는 것을 재확인함. (`http://catalog/ticketing` vs `http://catalog:8080`)  
- Nginx에서 SSE 지연을 막으려면 단순 `proxy_buffering off` 외에도 `X-Accel-Buffering no`, `read_timeout` 설정이 필요함.  
- 컨테이너 간 통신은 반드시 **서비스명:포트**를 사용해야 하며, `localhost`는 EC2 내부 모듈 간 호출에는 사용할 수 없음.  

---

## 🎯 내일 할 일 (Day3 예정)
- GitHub Actions 기반 최소 CI/CD 파이프라인 구성  
  - main 브랜치 push → Jib 빌드 & GHCR 푸시 → EC2 SSH 접속 후 `docker compose pull && up -d` 자동 반영  
- 실패 시 수동 롤백 스크립트 정리 (`docker compose down && up -d` + 이전 이미지 태그)  
- DoD: main push → 자동 배포 → 프론트에서 즉시 반영 확인  
