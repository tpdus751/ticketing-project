# W03 D01 (2025-09-13)

## ✅ 오늘 한 일

### BE
- **계약(Contract) 고정**
  - 왜? → 모듈 간 API와 이벤트 포맷이 바뀌면 추후 부하테스트와 안정성 검증이 깨질 수 있음.
  - 그래서 → Order, Payment, Reservation, Catalog 간 API/이벤트 스키마를 확정하고 변경 불가 원칙 적용.
  - 결과 → 모듈 간 호출 및 Kafka 이벤트 필드 구조 고정 완료.

- **서비스별 Health/Consistency 엔드포인트 추가**
  - 왜? → 부하테스트 및 운영 환경에서 서비스 정상 여부와 데이터 일관성을 빠르게 확인하기 위함.
  - 그래서 → `/actuator/health` 기본 외에, Consistency 체크용 간단 엔드포인트 추가.
  - 결과 → Catalog / Reservation / Order / Payment 서비스 모두 응답 확인.

- **로그 TraceId 통합**
  - 왜? → Jaeger traceId와 콘솔 로그 traceId가 일치하지 않아 디버깅에 혼선 발생.
  - 그래서 → `TraceIdFilter` 개선, MDC + W3C traceparent 통일 적용.
  - 결과 → Jaeger UI와 각 모듈 로그의 traceId가 일관되게 출력됨.

- **메트릭 추가**
  - 왜? → Grafana 대시보드에서 Order/Payment/Reservation 전체 플로우를 관측하기 위함.
  - 그래서 → 
    - Order: `order_request_total`, `order_confirmed_total`, `order_cancelled_total`, `order_latency`
    - Payment: `payment_success_total`, `payment_fail_total`, 실패율
    - Reservation: `reservation_hold_success_total`, `reservation_hold_conflict_total`, `reservation_confirm_success_total`, `reservation_confirm_failed_total`
  - 결과 → Grafana에서 모든 패널 정상 시각화 확인.

### Infra/테스트
- **k6 부하테스트 실행**
  - 왜? → 400 VU 규모에서 좌석 선점 + 주문 + 결제 흐름의 안정성 확인 필요.
  - 그래서 → 단계적 ramp-up → 유지 → ramp-down 시나리오로 실행.
  - 결과 → 
    - Checks 100% 성공 (모든 hold/order 요청 처리됨).
    - 평균 응답속도 127ms (p95 약 200ms).
    - 단, k6 종료 후에도 Outbox/SagaWorker, Kafka Consumer backlog로 인해 1~2분간 로그 지속 발생.

- **Grafana 대시보드 검증**
  - 왜? → 실제 메트릭 수집 및 시각화 여부 확인.
  - 그래서 → Payment Fail/Success, Order Confirm/Cancel, Hold Success/Conflict 등 시각화.
  - 결과 → 메트릭 지표는 정상 반영되었으나, **비동기 후속 처리 지연**으로 인해 API 응답 속도와 최종 상태 반영 간 차이 존재 확인.

---

## 📚 배운 점
- API 응답(latency)와 최종 상태 확정(latency)은 서로 다르며, SLA 기준을 어디에 둘지 명확히 해야 함.
- OutboxWorker / SagaWorker가 단일 스레드로 동작해 backlog가 생기면 테스트 종료 후에도 로그가 계속 쌓이는 현상이 발생.
- Kafka Consumer 병렬성을 늘려도 파티션 개수와 병렬 처리 구조에 따라 처리 한계가 명확함.

---

## 🚀 내일 할 일 (Day2 예정)
- OutboxWorker / SagaWorker 병렬 처리 개선 (`@Async + ThreadPoolTaskExecutor` 적용).
- Kafka Consumer 파티션/동시성 조정.
- Outbox 이벤트 처리 지연 메트릭 추가 (created_at → published_at 차이).
- SLA 기준 정의 (API 응답 vs 최종 SOLD 반영).
